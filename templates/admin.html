{% extends 'base.html' %}
{% block extra_css %}
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block body %}
<div class="admin-layout">

  <!-- SIDEBAR -->
  <aside class="admin-sidebar">
    <div class="sidebar-logo">CosyPOS Admin</div>
    <nav class="sidebar-nav">
      <a href="{{ url_for('admin') }}"
         class="sidebar-link {% if request.endpoint=='admin' %}active{% endif %}">
        <span class="icon">üè†</span>Home
      </a>
      <a href="{{ url_for('upload') }}"
         class="sidebar-link {% if request.endpoint=='upload' %}active{% endif %}">
        <span class="icon">‚úèÔ∏è</span>Draw
      </a>
      <a href="{{ url_for('admin_ratings') }}"
         class="sidebar-link {% if request.endpoint=='admin_ratings' %}active{% endif %}">
        <span class="icon">‚≠ê</span>Manage Ratings
      </a>
      <a href="{{ url_for('guest_table') }}"
         class="sidebar-link {% if request.endpoint=='guest_table' %}active{% endif %}">
        <span class="icon">üë•</span>Guests
      </a>
    </nav>
  </aside>

  <!-- MAIN PANEL -->
  <main class="admin-main">

    <!-- TOP CONTROLS -->
    <div class="controls">
      <a href="{{ url_for('admin_export') }}" class="btn">Download JSON</a>
      <form action="{{ url_for('upload') }}" method="POST"
            enctype="multipart/form-data" class="inline-form">
        <input id="baseFile" type="file" name="file" accept="image/*" hidden
               onchange="this.form.submit()">
        <button type="button" class="btn"
                onclick="document.getElementById('baseFile').click()">
          Upload New Menu
        </button>
      </form>
      <form action="{{ url_for('toggle_menu') }}" method="POST"
            class="inline-form">
        <button type="submit" class="btn">
          {{ 'Unpublish Menu' if menu_available else 'Publish Menu' }}
        </button>
      </form>
    </div>

    <!-- METRICS ROW -->
    <section class="metrics-row">
      <div class="metric-card">
        <div class="metric-title">Guests</div>
        <div class="metric-value">{{ guests|length }}</div>
      </div>
      <div class="metric-card">
        <div class="metric-title">Surveys ‚â•5 steps</div>
        <div class="metric-value">{{ completed_surveys }}</div>
      </div>
      <div class="metric-card">
        <div class="metric-title">Drinks</div>
        <div class="metric-value">{{ settings.drink_options|length }}</div>
      </div>
      <div class="metric-card">
        <div class="metric-title">Last Upload</div>
        <div class="metric-value">
          {% if previews and previews[0].url %}
            {{ previews[0].url.split('/')[-1] }}
          {% else %}‚Äî{% endif %}
        </div>
      </div>
    </section>

    <!-- SECTION TABS -->
    <div class="admin-tabs">
      <button class="tab-button active" data-tab="drinks">Drink Manager</button>
      <button class="tab-button" data-tab="menus">Menu Previews</button>
      <button class="tab-button" data-tab="courses">Courses</button>
    </div>

    <!-- TAB: DRINK MANAGER -->
    <section id="drinks" class="tab-content active">
      <div class="drink-manager">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
              {% for cat, msg in messages %}
                <li class="flash-{{cat}}">{{ msg }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        <form action="{{ url_for('add_drink') }}" method="POST" class="drink-form">
          <input type="text" name="drink" placeholder="New drink name‚Ä¶" required>
          <button type="submit" class="btn">Add</button>
        </form>

        {% if settings.drink_options %}
        <details class="drink-details">
          <summary>Existing Drinks</summary>
          <ul class="drink-list">
            {% for d in settings.drink_options %}
            <li>
              {{ d }}
              <form action="{{ url_for('delete_drink', drink=d) }}"
                    method="POST" class="inline-delete-form">
                <button class="inline-delete">√ó</button>
              </form>
            </li>
            {% endfor %}
          </ul>
        </details>
        {% endif %}
      </div>
    </section>

    <!-- TAB: MENU PREVIEWS -->
    <section id="menus" class="tab-content">
      <div class="previews-section">
        <div class="previews-grid">
          {% for p in previews %}
          <div class="preview">
            <strong>{{ p.name }}</strong>
            <img src="{{ p.url }}" alt="{{ p.name }} preview">
          </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- TAB: COURSES -->
    <section id="courses" class="tab-content">
      <div class="previews-section">
        <div class="previews-grid">
          {% for c in courses %}
          <div class="preview">
            <strong>Order {{ c.order }}</strong>
            <div>{{ c.name }}</div>
          </div>
          {% endfor %}
        </div>
      </div>
    </section>

  </main>
</div>
{% endblock %}
{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
<script>
  // flash auto-clear
  setTimeout(()=>{
    document.querySelectorAll('.flash-messages li')
            .forEach(li=>li.remove());
  },1500);

  // live image-refresh
  socket.on('image_updated',()=>setTimeout(()=>location.reload(),300));

  // tabs
  document.querySelectorAll('.tab-button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelector('.tab-button.active').classList.remove('active');
      btn.classList.add('active');
      document.querySelector('.tab-content.active').classList.remove('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });
</script>
{% endblock %}