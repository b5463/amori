{% extends 'base.html' %}

{% block extra_css %}
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
  <!-- Font Awesome 6.5.1 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
{% endblock %}

{% block body %}
<div class="admin-layout">

  <!-- ▸ SIDEBAR -->
  <aside class="admin-sidebar">
    <div class="sidebar-logo">
      <img src="{{ url_for('static', filename='icons/icon-192-dark.png') }}" alt="amori logo">
    </div>
    <nav class="sidebar-nav">
      <a href="{{ url_for('admin') }}"         class="sidebar-link {% if request.endpoint=='admin' %}active{% endif %}">Home</a>
      <a href="{{ url_for('upload') }}"        class="sidebar-link {% if request.endpoint=='upload' %}active{% endif %}">Draw</a>
      <a href="{{ url_for('admin_ratings') }}" class="sidebar-link {% if request.endpoint=='admin_ratings' %}active{% endif %}">Courses</a>
      <a href="{{ url_for('guest_table') }}"   class="sidebar-link {% if request.endpoint=='guest_table' %}active{% endif %}">Guests</a>
      <a href="{{ url_for('admin_table') }}"   class="sidebar-link {% if request.endpoint=='admin_table' %}active{% endif %}">Table</a>
    </nav>
  </aside>

  <!-- ▸ MAIN PANEL -->
  <main class="admin-main">

    <!-- Top-bar -->
    <div class="top-bar">
      <div class="controls">
        <a href="{{ url_for('admin_export') }}" class="btn-outline">Download&nbsp;JSON</a>

        <form action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data" class="inline-form">
          <input id="baseFile" type="file" name="file" accept="image/*" hidden onchange="this.form.submit()">
          <button type="button" class="btn-outline" onclick="document.getElementById('baseFile').click()">Upload&nbsp;Menu</button>
        </form>

        <form action="{{ url_for('toggle_menu') }}" method="POST" class="inline-form">
          <button type="submit" class="btn-outline">{{ 'Unpublish Menu' if menu_available else 'Publish Menu' }}</button>
        </form>
      </div>

      <label class="top-search">
        <i class="fa-solid fa-search"></i>
        <input type="search" placeholder="Search">
      </label>
    </div>

    <!-- Page title -->
    <h1 class="page-title">Dashboard</h1>

    <!-- ROW 1 · Metric tiles -->
    <section class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="fa-solid fa-users"></i></div>
        <div class="stat-title">Guests</div>
        <div class="stat-value">{{ guests|length }}</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon"><i class="fa-solid fa-book-open"></i></div>
        <div class="stat-title">Courses</div>
        <div class="stat-value">{{ courses|length }}</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon"><i class="fa-solid fa-mug-hot"></i></div>
        <div class="stat-title">Drinks</div>
        <div class="stat-value">{{ settings.drink_options|length }}</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon"><i class="fa-solid fa-file-upload"></i></div>
        <div class="stat-title">Last&nbsp;Upload</div>
        <div class="stat-value">
          {% if previews and previews[0].url %}
            {{ previews[0].url.split('/')[-1] }}
          {% else %}
            &mdash;
          {% endif %}
        </div>
      </div>
    </section>

    <!-- ROW 2 · Guests | Drink-manager -->
    <section class="panel-grid-4">

      <!-- Guests panel -->
      <section class="panel guests-panel">
        <div class="panel-header">
          <h2 class="panel-title">Guests</h2>
          <a href="{{ url_for('guest_table') }}" class="see-all">See&nbsp;more</a>
        </div>

        <ul class="guest-list">
          {% for name, g in guests.items() %}
          <li class="guest-row">
            <span class="guest-avatar">{{ loop.index }}</span>
            <div class="guest-info">
              <strong>{{ name }}</strong>
              <small class="guest-id">SEATING:&nbsp;{{ g.seating }}</small>
            </div>
          </li>
          {% endfor %}
        </ul>
      </section>

      <!-- Drink Manager -->
      <section class="panel drink-mini">
        <h2 class="panel-title">Drink Manager</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
              {% for cat, msg in messages %}
                <li class="flash-{{ cat }}">{{ msg }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        <form action="{{ url_for('add_drink') }}" method="POST" class="drink-form">
          <input type="text" name="drink" placeholder="New drink name…" required>
          <button type="submit" class="btn-primary">Add</button>
        </form>

        {% if settings.drink_options %}
        <details class="drink-details" open>
          <summary>Existing Drinks</summary>
          <ul class="drink-list">
            {% for d in settings.drink_options %}
            <li>
              {{ d }}
              <form action="{{ url_for('delete_drink', drink=d) }}" method="POST" class="inline-delete-form">
                <button class="inline-delete">&times;</button>
              </form>
            </li>
            {% endfor %}
          </ul>
        </details>
        {% endif %}
      </section>

    </section><!-- /panel-grid -->

  </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const details = document.querySelector('.drink-details');
    if (details) details.scrollTop = details.scrollHeight;
  });

  setTimeout(() => {
    document.querySelectorAll('.flash-messages li')
            .forEach(li => li.remove());
  }, 1500);

  // live‐reload images & table
  socket.on('image_updated', () =>
    setTimeout(() => location.reload(), 300)
  );
</script>
{% endblock %}