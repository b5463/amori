{# templates/manage_ratings.html #}
{% extends 'base.html' %}

{% block title %}Course Feedback & Ratings{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/manage.css') }}">
{% endblock %}

{% block body %}
<div class="admin-layout">

  <!-- ▸ SIDEBAR -->
  <aside class="admin-sidebar">
    <div class="sidebar-logo">
      <img src="{{ url_for('static', filename='icons/icon-192-dark.png') }}" alt="amori logo">
    </div>
    <nav class="sidebar-nav">
      <a href="{{ url_for('admin') }}"         class="sidebar-link {% if request.endpoint=='admin' %}active{% endif %}">Home</a>
      <a href="{{ url_for('upload') }}"        class="sidebar-link {% if request.endpoint=='upload' %}active{% endif %}">Draw</a>
      <a href="{{ url_for('admin_ratings') }}" class="sidebar-link {% if request.endpoint=='admin_ratings' %}active{% endif %}">Courses</a>
      <a href="{{ url_for('guest_table') }}"   class="sidebar-link {% if request.endpoint=='guest_table' %}active{% endif %}">Guests</a>
      <a href="{{ url_for('admin_table') }}"   class="sidebar-link {% if request.endpoint=='admin_table' %}active{% endif %}">Table</a>
    </nav>
  </aside>

  <!-- ▸ MAIN PANEL -->
  <main class="admin-main">

    <!-- Header row -->
    <div class="ratings-header">
      <h1 class="page-title">Manage Courses</h1>

      <div class="actions">
        <form action="{{ url_for('admin_clear_ratings', next=request.path) }}"
              method="POST"
              onsubmit="return confirm('Delete all ratings?');"
              style="display:inline">
          <button type="submit" class="btn-destructive">🗑️ Clear&nbsp;All</button>
        </form>
      </div>
    </div>

    <!-- Add-course form -->
    <form action="{{ url_for('admin_add_course', next=request.path) }}"
          method="POST"
          class="add-course-form">
      <input name="name"
             type="text"
             placeholder="Course Name"
             required>

      <input name="order"
             type="number"
             min="1"
             value="{{ courses|length + 1 }}"
             required>

      <button type="submit" class="btn-outline">+ Add</button>
    </form>

    <!-- Course cards -->
    {% if courses %}
      {% for c in courses|sort(attribute='order') %}
        <div class="course-card">

          <div class="course-card-header">
            <h3>{{ c.order }}.&nbsp;{{ c.name }}</h3>

            <div class="course-actions">
              <button class="btn-outline rate-course"
                      data-id="{{ c.id }}">▶ Rate</button>

              <form action="{{ url_for('admin_delete_course',
                                       cid=c.id,
                                       next=request.path) }}"
                    method="POST"
                    style="display:inline">
                <button type="submit" class="btn-destructive">✕</button>
              </form>
            </div>
          </div>

          {% set cr = ratings|selectattr('course_id','equalto',c.id)|list %}
          {% if cr %}
            <ul class="ratings-list">
              {% for r in cr %}
                <li class="rating-item">
                  <span class="guest">{{ r.guest }}</span>

                  {% if r.feedback %}
                    <div class="feedback">“{{ r.feedback }}”</div>
                  {% endif %}

                  <span class="score">{{ r.score }}/5</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="no-ratings">No ratings yet.</div>
          {% endif %}

        </div>
      {% endfor %}
    {% else %}
      <div class="no-ratings">No courses defined.</div>
    {% endif %}

  </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>const socket = io();</script>
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}